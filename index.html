<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DeckForge – Standards-Based PowerPoint Deck Builder</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* Small polish: scrollbar + sticky headers */
    .soft-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
    .soft-scroll::-webkit-scrollbar-thumb { border-radius: 999px; background: rgba(0,0,0,.15); }
    .soft-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,.04); }
    .drag-hint { cursor: grab; }
    .dragging { opacity: .5; cursor: grabbing; }
    .toast { animation: toastIn .25s ease-out; }
    @keyframes toastIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Top bar -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white grid place-items-center shadow-sm">
        <i class="fa-solid fa-layer-group"></i>
      </div>
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <h1 class="text-lg font-semibold leading-tight">DeckForge</h1>
          <span class="text-xs px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600">topic-agnostic</span>
          <span id="strategyBadge" class="text-xs px-2 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700 hidden">Strategy compliant</span>
        </div>
        <p class="text-xs text-slate-500">Build standardized deck blueprints from learning outcomes + content points (GitHub-friendly spec).</p>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnReset" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
          <i class="fa-solid fa-rotate-left mr-2"></i>Reset
        </button>
        <button id="btnExport" class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm shadow-sm">
          <i class="fa-solid fa-download mr-2"></i>Export spec
        </button>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left: Builder -->
    <section class="lg:col-span-7 space-y-6">
      <!-- Stepper -->
      <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <span class="text-xs px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600">Workflow</span>
            <span id="stepLabel" class="text-sm font-medium">1) Setup</span>
          </div>
          <div class="flex gap-2">
            <button id="btnPrev" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" disabled>
              <i class="fa-solid fa-chevron-left mr-2"></i>Back
            </button>
            <button id="btnNext" class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm">
              Next<i class="fa-solid fa-chevron-right ml-2"></i>
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-4 gap-2">
          <div class="step-pill" data-step="0"></div>
          <div class="step-pill" data-step="1"></div>
          <div class="step-pill" data-step="2"></div>
          <div class="step-pill" data-step="3"></div>
        </div>
      </div>

      <!-- Step 1: Setup -->
      <div id="step0" class="step-panel bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-base font-semibold">Deck Setup</h2>
            <p class="text-sm text-slate-500 mt-1">Choose variables. The system enforces structure + standards behind the scenes.</p>
          </div>
          <div class="text-xs text-slate-500">
            <span class="px-2 py-1 rounded-full bg-slate-100 border border-slate-200">Smart defaults</span>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium">Deck title</label>
            <input id="deckTitle" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10"
              placeholder="e.g., Teaching Strategy Microtraining" />
          </div>

          <div>
            <label class="text-sm font-medium">Audience level</label>
            <select id="audienceLevel" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10">
              <option>Certificate</option>
              <option>Diploma</option>
              <option selected>Degree</option>
              <option>Masters</option>
              <option>Doctorate</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Duration</label>
            <select id="duration" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10">
              <option value="10">10 mins</option>
              <option value="15" selected>15 mins</option>
              <option value="30">30 mins</option>
              <option value="60">60 mins</option>
              <option value="90">90 mins</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Teaching strategy</label>
            <select id="strategy" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10">
              <option value="direct" selected>Direct Instruction</option>
              <option value="pbl">Problem-Based Learning (PBL)</option>
              <option value="collab">Collaborative Learning</option>
              <option value="inquiry">Inquiry-Based Learning</option>
              <option value="experiential">Experiential Learning</option>
              <option value="flipped">Flipped Classroom</option>
              <option value="scaffolded">Scaffolded Learning</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Interactivity level</label>
            <div class="mt-1 grid grid-cols-3 gap-2">
              <button class="btnChoice choiceInteractivity px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="low">Low</button>
              <button class="btnChoice choiceInteractivity px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="medium">Medium</button>
              <button class="btnChoice choiceInteractivity px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="high">High</button>
            </div>
          </div>

          <div>
            <label class="text-sm font-medium">Tone</label>
            <select id="tone" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10">
              <option>Formal</option>
              <option selected>Practical</option>
              <option>Workshop</option>
              <option>Coaching</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Assessment context</label>
            <select id="assessmentContext" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10">
              <option value="none" selected>None</option>
              <option value="formative">Formative (low stakes)</option>
              <option value="summative">Summative (high stakes)</option>
              <option value="authentic">Authentic / performance task</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">GenAI policy</label>
            <select id="genaiPolicy" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10">
              <option value="allowed">Allowed</option>
              <option value="limited" selected>Limited</option>
              <option value="prohibited">Prohibited</option>
            </select>
          </div>
        </div>

        <div class="mt-5 flex flex-wrap gap-2">
          <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">
            <input id="toggleSpeakerNotes" type="checkbox" class="rounded" checked />
            Include facilitator speaker notes
          </label>
          <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">
            <input id="toggleLOMapping" type="checkbox" class="rounded" checked />
            Enforce LO coverage rules
          </label>
          <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">
            <input id="toggleRefs" type="checkbox" class="rounded" checked />
            Include references slide
          </label>
        </div>
      </div>

      <!-- Step 2: Inputs -->
      <div id="step1" class="step-panel hidden bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-base font-semibold">Learning Outcomes & Content Inputs</h2>
            <p class="text-sm text-slate-500 mt-1">Paste your LOs and key content points. The generator uses these to create a standardized slide blueprint.</p>
          </div>
          <button id="btnAutofill" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Example fill
          </button>
        </div>

        <div class="mt-5 grid grid-cols-1 gap-4">
          <div>
            <label class="text-sm font-medium">Learning outcomes (one per line)</label>
            <textarea id="learningOutcomes" rows="6"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10 soft-scroll"
              placeholder="e.g.,\n1) Explain …\n2) Apply …\n3) Evaluate …"></textarea>
            <div class="mt-2 flex items-center justify-between text-xs text-slate-500">
              <span id="loCount">0 outcomes detected</span>
              <span id="bloomHint" class="hidden px-2 py-1 rounded-full bg-amber-50 border border-amber-200 text-amber-700">
                Tip: start each LO with an action verb
              </span>
            </div>
          </div>

          <div>
            <label class="text-sm font-medium">Topic & key content points</label>
            <input id="topicTitle" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10"
              placeholder="Topic title (not discipline-specific)" />
            <textarea id="contentPoints" rows="6"
              class="mt-2 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10 soft-scroll"
              placeholder="Key points (bullets), one per line\n- Define …\n- Steps of …\n- Common pitfalls …\n- Best practices …"></textarea>
          </div>

          <div>
            <label class="text-sm font-medium">References (optional, one per line)</label>
            <textarea id="references" rows="5"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10 soft-scroll"
              placeholder="APA/DOI/URL references\n(you can keep this empty)"></textarea>
            <div class="mt-2 text-xs text-slate-500">
              The app will include a References slide if toggled on and at least 1 reference is provided.
            </div>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnGenerateBlueprint" class="px-4 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm shadow-sm">
            <i class="fa-solid fa-diagram-project mr-2"></i>Generate slide blueprint
          </button>
          <button id="btnClearInputs" class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
            <i class="fa-solid fa-eraser mr-2"></i>Clear
          </button>
        </div>
      </div>

      <!-- Step 3: Blueprint -->
      <div id="step2" class="step-panel hidden bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-base font-semibold">Slide Blueprint</h2>
            <p class="text-sm text-slate-500 mt-1">Drag to reorder. Add or remove slides using standardized types. LO coverage and time fit update live.</p>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnAddSlide" class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm shadow-sm">
              <i class="fa-solid fa-plus mr-2"></i>Add slide
            </button>
            <button id="btnAutoFix" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
              <i class="fa-solid fa-screwdriver-wrench mr-2"></i>Auto-fix rules
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
            <div class="text-xs text-slate-500">Engagement density</div>
            <div class="mt-1 flex gap-2">
              <button class="btnChoice choiceEng px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="low">Low</button>
              <button class="btnChoice choiceEng px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="medium">Medium</button>
              <button class="btnChoice choiceEng px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="high">High</button>
            </div>
          </div>
          <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
            <div class="text-xs text-slate-500">Time per slide (estimate)</div>
            <div class="mt-1 grid grid-cols-3 gap-2">
              <button class="btnChoice choicePace px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="fast">Fast</button>
              <button class="btnChoice choicePace px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="standard">Standard</button>
              <button class="btnChoice choicePace px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" data-value="slow">Slow</button>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold">Slides</h3>
            <div class="text-xs text-slate-500">Tip: drag handle to reorder</div>
          </div>

          <div id="slidesList" class="mt-2 space-y-2"></div>
        </div>
      </div>

      <!-- Step 4: Review & Export -->
      <div id="step3" class="step-panel hidden bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-base font-semibold">Review & Export</h2>
            <p class="text-sm text-slate-500 mt-1">Preview the standardized deck spec. Export as JSON for GitHub versioning.</p>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnCopySpec" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
              <i class="fa-solid fa-copy mr-2"></i>Copy
            </button>
            <button id="btnExport2" class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm shadow-sm">
              <i class="fa-solid fa-download mr-2"></i>Download
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <h3 class="text-sm font-semibold">Quality checks</h3>
            <ul id="qualityList" class="mt-3 space-y-2 text-sm"></ul>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <h3 class="text-sm font-semibold">Deck spec (JSON)</h3>
            <pre id="specPreview" class="mt-3 text-xs mono bg-white border border-slate-200 rounded-xl p-3 max-h-[380px] overflow-auto soft-scroll"></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- Right: Dashboard -->
    <aside class="lg:col-span-5 space-y-6">
      <!-- Readiness -->
      <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-base font-semibold">Deck Readiness</h2>
            <p class="text-sm text-slate-500 mt-1">Live indicators to keep decks standardized and usable.</p>
          </div>
          <span id="readinessPill" class="text-xs px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600">Not ready</span>
        </div>

        <div class="mt-4 space-y-4">
          <div>
            <div class="flex justify-between text-sm">
              <span class="text-slate-600">LO coverage</span>
              <span id="loCoverageText" class="font-medium">0%</span>
            </div>
            <div class="mt-2 h-2 rounded-full bg-slate-100 overflow-hidden">
              <div id="loCoverageBar" class="h-2 w-0 bg-slate-900 rounded-full"></div>
            </div>
          </div>

          <div>
            <div class="flex justify-between text-sm">
              <span class="text-slate-600">Time fit</span>
              <span id="timeFitText" class="font-medium">—</span>
            </div>
            <div class="mt-2 h-2 rounded-full bg-slate-100 overflow-hidden">
              <div id="timeFitBar" class="h-2 w-0 bg-slate-900 rounded-full"></div>
            </div>
          </div>

          <div>
            <div class="flex justify-between text-sm">
              <span class="text-slate-600">Engagement density</span>
              <span id="engagementText" class="font-medium">—</span>
            </div>
            <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
              <div class="p-2 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-slate-500">Activity</div>
                <div id="countActivity" class="font-semibold text-slate-900">0</div>
              </div>
              <div class="p-2 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-slate-500">CFU</div>
                <div id="countCFU" class="font-semibold text-slate-900">0</div>
              </div>
              <div class="p-2 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-slate-500">Reflection</div>
                <div id="countReflection" class="font-semibold text-slate-900">0</div>
              </div>
            </div>
          </div>

          <div class="pt-2 border-t border-slate-200">
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-600">Warnings</span>
              <span id="warnCount" class="text-xs px-2 py-1 rounded-full bg-amber-50 border border-amber-200 text-amber-700">0</span>
            </div>
            <ul id="warningsList" class="mt-2 text-sm space-y-2"></ul>
          </div>
        </div>
      </div>

      <!-- Slide type catalog -->
      <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-base font-semibold">Standard Slide Types</h2>
            <p class="text-sm text-slate-500 mt-1">Your app enforces these building blocks (topic-agnostic).</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600">Canonical</span>
        </div>

        <div id="slideCatalog" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>

        <div class="mt-4 text-xs text-slate-500">
          Tip: Keep design freedom constrained—offer a few themes + density options, not unlimited customization.
        </div>
      </div>
    </aside>
  </main>

  <!-- Add Slide Modal -->
  <div id="modalBackdrop" class="hidden fixed inset-0 z-40 bg-black/40"></div>
  <div id="modal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-lg bg-white rounded-2xl border border-slate-200 shadow-lg">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div>
          <div class="text-sm font-semibold">Add a slide</div>
          <div class="text-xs text-slate-500">Choose a standardized slide type.</div>
        </div>
        <button id="btnCloseModal" class="w-9 h-9 rounded-xl border border-slate-200 hover:bg-slate-50 grid place-items-center">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="p-4 space-y-3">
        <div>
          <label class="text-sm font-medium">Slide type</label>
          <select id="newSlideType" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10"></select>
        </div>

        <div>
          <label class="text-sm font-medium">Title</label>
          <input id="newSlideTitle" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10"
                 placeholder="A clear, specific title (prefer verbs/claims)" />
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium">LO mapping</label>
            <select id="newSlideLO" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10">
              <option value="">(none)</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Estimated time (mins)</label>
            <input id="newSlideTime" type="number" min="0" step="0.5"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10"
              value="2" />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium">Bullets (optional)</label>
          <textarea id="newSlideBullets" rows="4"
            class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/10 soft-scroll"
            placeholder="- Keep it concise\n- Max ~6 bullets"></textarea>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button id="btnCancelAdd" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">Cancel</button>
          <button id="btnConfirmAdd" class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm shadow-sm">
            <i class="fa-solid fa-plus mr-2"></i>Add
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastHost" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] space-y-2"></div>

<script>
/* =========================
   DeckForge (topic-agnostic)
   ========================= */

const SLIDE_TYPES = [
  { id: "title_context", label: "Title & Context", cat: "Foundation", desc: "Purpose, audience, duration, strategy." },
  { id: "learning_outcomes", label: "Learning Outcomes", cat: "Foundation", desc: "3–5 outcomes, action verbs." },
  { id: "roadmap", label: "Session Roadmap", cat: "Foundation", desc: "Flow + time blocks." },

  { id: "concept_overview", label: "Concept Overview", cat: "Knowledge", desc: "One main idea, intro." },
  { id: "concept_deepening", label: "Concept Deepening", cat: "Knowledge", desc: "Build complexity (sequence)." },
  { id: "framework_model", label: "Framework / Process / Model", cat: "Knowledge", desc: "Visual-first representation." },

  { id: "guided_question", label: "Guided Question", cat: "Engagement", desc: "Prompt thinking/prediction." },
  { id: "activity_task", label: "Activity / Task", cat: "Engagement", desc: "Output-driven task." },
  { id: "check_understanding", label: "Check for Understanding (CFU)", cat: "Engagement", desc: "Poll/MCQ/diagnostic." },

  { id: "application_example", label: "Application / Example", cat: "Transfer", desc: "Generic scenario transfer." },
  { id: "compare_evaluate", label: "Compare / Evaluate", cat: "Transfer", desc: "Contrast and judge." },
  { id: "reflection", label: "Reflection", cat: "Transfer", desc: "Metacognitive wrap-up." },

  { id: "assessment_alignment", label: "Assessment Alignment", cat: "Academic Practice", desc: "Criteria-oriented alignment." },
  { id: "genai_practice", label: "GenAI / Academic Practice", cat: "Academic Practice", desc: "Policy + acceptable use." },
  { id: "references", label: "References", cat: "Academic Practice", desc: "Auto-formatted list." },

  // Strategy-specific helpers (still topic-agnostic)
  { id: "problem_brief", label: "Problem Brief (PBL)", cat: "Strategy", desc: "Problem first, before explanations." },
  { id: "roles_accountability", label: "Roles & Accountability (Collab)", cat: "Strategy", desc: "Roles, norms, output." },
  { id: "preclass_tasks", label: "Pre-class Tasks (Flipped)", cat: "Strategy", desc: "What learners do before class." }
];

const STRATEGY_RULES = {
  direct: {
    name: "Direct Instruction",
    required: ["learning_outcomes", "concept_overview", "check_understanding", "reflection"],
    recommended: ["roadmap", "concept_deepening", "guided_question"],
    engagementEveryMins: 15
  },
  pbl: {
    name: "Problem-Based Learning (PBL)",
    required: ["learning_outcomes", "problem_brief", "guided_question", "application_example", "reflection"],
    recommended: ["compare_evaluate", "check_understanding"],
    engagementEveryMins: 12
  },
  collab: {
    name: "Collaborative Learning",
    required: ["learning_outcomes", "roles_accountability", "activity_task", "compare_evaluate", "reflection"],
    recommended: ["check_understanding", "guided_question"],
    engagementEveryMins: 12
  },
  inquiry: {
    name: "Inquiry-Based Learning",
    required: ["learning_outcomes", "guided_question", "concept_deepening", "framework_model", "reflection"],
    recommended: ["check_understanding", "application_example"],
    engagementEveryMins: 12
  },
  experiential: {
    name: "Experiential Learning",
    required: ["learning_outcomes", "activity_task", "reflection", "concept_overview", "application_example"],
    recommended: ["check_understanding"],
    engagementEveryMins: 12
  },
  flipped: {
    name: "Flipped Classroom",
    required: ["learning_outcomes", "preclass_tasks", "check_understanding", "activity_task", "application_example", "reflection"],
    recommended: ["compare_evaluate"],
    engagementEveryMins: 12
  },
  scaffolded: {
    name: "Scaffolded Learning",
    required: ["learning_outcomes", "concept_overview", "concept_deepening", "guided_question", "application_example"],
    recommended: ["check_understanding", "reflection"],
    engagementEveryMins: 15
  }
};

const DEFAULTS = {
  interactivity: "medium",
  engagement: "medium",
  pace: "standard"
};

let state = {
  step: 0,

  meta: {
    title: "",
    audienceLevel: "Degree",
    duration: 15,
    strategy: "direct",
    interactivity: DEFAULTS.interactivity,
    tone: "Practical",
    assessmentContext: "none",
    genaiPolicy: "limited",
    includeSpeakerNotes: true,
    enforceLOMapping: true,
    includeRefsSlide: true
  },

  inputs: {
    learningOutcomes: [],
    topicTitle: "",
    contentPoints: [],
    references: []
  },

  blueprint: {
    slides: [],
    engagement: DEFAULTS.engagement,
    pace: DEFAULTS.pace
  }
};

/* ---------- Helpers ---------- */
function $(id) { return document.getElementById(id); }
function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
function uid() { return Math.random().toString(16).slice(2, 10); }

function toast(msg, kind="info") {
  const host = $("toastHost");
  const el = document.createElement("div");
  const color = kind==="ok" ? "bg-emerald-600" : kind==="warn" ? "bg-amber-600" : "bg-slate-900";
  el.className = `toast ${color} text-white text-sm px-4 py-2 rounded-2xl shadow-lg flex items-center gap-2`;
  el.innerHTML = `<i class="fa-solid fa-circle-info"></i><span>${msg}</span>`;
  host.appendChild(el);
  setTimeout(()=> {
    el.style.opacity = 0;
    el.style.transform = "translateY(10px)";
    el.style.transition = "all .2s ease";
    setTimeout(()=> el.remove(), 220);
  }, 2200);
}

function parseLines(text) {
  return text
    .split("\n")
    .map(s => s.trim())
    .filter(Boolean)
    .map(s => s.replace(/^[-•\d\)\.]+\s*/, "")); // strip bullets/numbering
}

function strategyName() {
  return STRATEGY_RULES[state.meta.strategy]?.name ?? "Strategy";
}

function slideTypeById(id) {
  return SLIDE_TYPES.find(s => s.id === id);
}

function isEngagementType(typeId) {
  return ["guided_question","activity_task","check_understanding","reflection","compare_evaluate"].includes(typeId);
}

function estimateBaseTimeByType(typeId) {
  // Very rough, later adjusted by pace
  const base = {
    title_context: 1.0,
    learning_outcomes: 1.5,
    roadmap: 1.0,
    concept_overview: 2.0,
    concept_deepening: 2.0,
    framework_model: 2.5,
    guided_question: 1.5,
    activity_task: 3.0,
    check_understanding: 2.0,
    application_example: 2.5,
    compare_evaluate: 2.5,
    reflection: 2.0,
    assessment_alignment: 2.0,
    genai_practice: 2.0,
    references: 1.0,
    problem_brief: 2.5,
    roles_accountability: 2.0,
    preclass_tasks: 1.5
  };
  return base[typeId] ?? 2.0;
}

function paceMultiplier() {
  if (state.blueprint.pace === "fast") return 0.85;
  if (state.blueprint.pace === "slow") return 1.15;
  return 1.0;
}

function totalTimeMins() {
  return state.blueprint.slides.reduce((sum, s) => sum + (Number(s.timeMins) || 0), 0);
}

/* ---------- UI: Stepper ---------- */
function renderStepper() {
  const labels = ["1) Setup", "2) Inputs", "3) Blueprint", "4) Export"];
  $("stepLabel").textContent = labels[state.step] ?? "Setup";
  $("btnPrev").disabled = state.step === 0;
  $("btnNext").textContent = state.step === 3 ? "Finish" : "Next";

  // panels
  ["step0","step1","step2","step3"].forEach((id, idx) => {
    $(id).classList.toggle("hidden", idx !== state.step);
  });

  // pills
  document.querySelectorAll(".step-pill").forEach((el) => {
    const i = Number(el.dataset.step);
    el.className = "step-pill h-2 rounded-full " + (i <= state.step ? "bg-slate-900" : "bg-slate-200");
  });

  if (state.step === 3) renderSpecPreview();
}

/* ---------- UI: Catalog ---------- */
function renderCatalog() {
  const host = $("slideCatalog");
  host.innerHTML = "";
  const groups = {};
  SLIDE_TYPES.forEach(s => {
    if (!groups[s.cat]) groups[s.cat] = [];
    groups[s.cat].push(s);
  });

  Object.entries(groups).forEach(([cat, items]) => {
    const block = document.createElement("div");
    block.className = "sm:col-span-2 mt-2";
    block.innerHTML = `<div class="text-xs font-semibold text-slate-600">${cat}</div>`;
    host.appendChild(block);

    items.forEach(s => {
      const card = document.createElement("div");
      card.className = "p-3 rounded-xl border border-slate-200 bg-slate-50";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="text-sm font-semibold">${s.label}</div>
            <div class="text-xs text-slate-500 mt-1">${s.desc}</div>
          </div>
          <span class="text-[10px] px-2 py-1 rounded-full bg-white border border-slate-200 text-slate-600">${s.id}</span>
        </div>
      `;
      host.appendChild(card);
    });
  });
}

/* ---------- Inputs sync ---------- */
function syncMetaFromUI() {
  state.meta.title = $("deckTitle").value.trim();
  state.meta.audienceLevel = $("audienceLevel").value;
  state.meta.duration = Number($("duration").value);
  state.meta.strategy = $("strategy").value;
  state.meta.tone = $("tone").value;
  state.meta.assessmentContext = $("assessmentContext").value;
  state.meta.genaiPolicy = $("genaiPolicy").value;

  state.meta.includeSpeakerNotes = $("toggleSpeakerNotes").checked;
  state.meta.enforceLOMapping = $("toggleLOMapping").checked;
  state.meta.includeRefsSlide = $("toggleRefs").checked;
}

function syncInputsFromUI() {
  state.inputs.learningOutcomes = parseLines($("learningOutcomes").value);
  state.inputs.topicTitle = $("topicTitle").value.trim();
  state.inputs.contentPoints = parseLines($("contentPoints").value);
  state.inputs.references = parseLines($("references").value);
}

/* ---------- LO analysis ---------- */
const BLOOM_VERBS = [
  "define","describe","explain","identify","summarize","outline",
  "apply","use","demonstrate","implement",
  "analyze","differentiate","compare","contrast",
  "evaluate","justify","critique",
  "create","design","develop","construct"
];

function updateLOStats() {
  const los = parseLines($("learningOutcomes").value);
  $("loCount").textContent = `${los.length} outcomes detected`;

  let ok = 0;
  for (const lo of los) {
    const first = lo.split(/\s+/)[0]?.toLowerCase() || "";
    if (BLOOM_VERBS.includes(first)) ok++;
  }
  const hint = $("bloomHint");
  hint.classList.toggle("hidden", !(los.length > 0 && ok / Math.max(1, los.length) < 0.5));
}

/* ---------- Blueprint generation ---------- */
function defaultSlideTitle(typeId) {
  const topic = state.inputs.topicTitle || "Session";
  const t = slideTypeById(typeId)?.label ?? "Slide";
  const map = {
    title_context: topic,
    learning_outcomes: "Learning outcomes",
    roadmap: "How we’ll work through this",
    concept_overview: "Core concept overview",
    concept_deepening: "Building understanding",
    framework_model: "Framework / process",
    guided_question: "Think: guiding question",
    activity_task: "Activity",
    check_understanding: "Check for understanding",
    application_example: "Apply: worked example",
    compare_evaluate: "Compare & evaluate",
    reflection: "Reflect",
    assessment_alignment: "Assessment alignment",
    genai_practice: "Academic practice (GenAI)",
    references: "References",
    problem_brief: "Problem brief",
    roles_accountability: "Roles & accountability",
    preclass_tasks: "Before class: tasks"
  };
  return map[typeId] || t;
}

function generateBlueprint() {
  syncMetaFromUI();
  syncInputsFromUI();

  const los = state.inputs.learningOutcomes;
  const hasRefs = state.inputs.references.length > 0;
  const includeRefs = state.meta.includeRefsSlide && hasRefs;
  const includeGenAI = state.meta.genaiPolicy !== "prohibited"; // still could show practice slide
  const includeAssessment = state.meta.assessmentContext !== "none";

  const rules = STRATEGY_RULES[state.meta.strategy];
  const req = rules?.required ?? ["learning_outcomes","concept_overview","reflection"];

  // Base skeleton always starts with title + LOs (title optional but recommended)
  const slides = [];
  slides.push(makeSlide("title_context", "", "", []));
  slides.push(makeSlide("learning_outcomes", "", los[0] ? "LO1" : "", []));

  // Strategy-required slides inserted next (excluding LOs already present)
  req.forEach(typeId => {
    if (typeId === "learning_outcomes") return;
    if (!slides.some(s => s.typeId === typeId)) slides.push(makeSlide(typeId));
  });

  // Add a roadmap for >= 15 mins
  if (state.meta.duration >= 15 && !slides.some(s => s.typeId === "roadmap")) {
    slides.splice(2, 0, makeSlide("roadmap"));
  }

  // Add conceptual build if content points exist
  if (state.inputs.contentPoints.length > 0) {
    // Ensure at least one concept overview
    if (!slides.some(s => s.typeId === "concept_overview")) slides.push(makeSlide("concept_overview"));
    // Add deepening based on duration
    if (state.meta.duration >= 30 && slides.filter(s => s.typeId === "concept_deepening").length < 2) {
      slides.push(makeSlide("concept_deepening"));
      slides.push(makeSlide("concept_deepening"));
    } else if (state.meta.duration >= 15 && !slides.some(s => s.typeId === "concept_deepening")) {
      slides.push(makeSlide("concept_deepening"));
    }
    // Add a framework slide for longer sessions
    if (state.meta.duration >= 30 && !slides.some(s => s.typeId === "framework_model")) {
      slides.push(makeSlide("framework_model"));
    }
  }

  // Engagement calibration
  state.blueprint.engagement = state.meta.interactivity; // start aligned
  const targetEng = state.blueprint.engagement;

  // Ensure at least one activity if medium/high
  if ((targetEng === "medium" || targetEng === "high") && !slides.some(s => s.typeId === "activity_task")) {
    slides.push(makeSlide("activity_task"));
  }
  // Ensure CFU appears at least once
  if (!slides.some(s => s.typeId === "check_understanding")) slides.push(makeSlide("check_understanding"));

  // Add application/evaluation if duration allows
  if (state.meta.duration >= 15 && !slides.some(s => s.typeId === "application_example")) {
    slides.push(makeSlide("application_example"));
  }
  if (state.meta.duration >= 30 && !slides.some(s => s.typeId === "compare_evaluate")) {
    slides.push(makeSlide("compare_evaluate"));
  }

  // Reflection near end
  if (!slides.some(s => s.typeId === "reflection")) slides.push(makeSlide("reflection"));

  // Academic practice slides near end
  if (includeAssessment && !slides.some(s => s.typeId === "assessment_alignment")) {
    slides.push(makeSlide("assessment_alignment"));
  }
  if (includeGenAI && !slides.some(s => s.typeId === "genai_practice")) {
    slides.push(makeSlide("genai_practice"));
  }
  if (includeRefs && !slides.some(s => s.typeId === "references")) {
    slides.push(makeSlide("references"));
  }

  // Assign LO mapping heuristics
  const loTags = los.map((_, idx) => `LO${idx+1}`);
  let loIdx = 0;
  slides.forEach((s, i) => {
    if (!state.meta.enforceLOMapping) return;
    // Map core learning slides to outcomes, rotate
    if (["concept_overview","concept_deepening","framework_model","application_example","compare_evaluate","activity_task","check_understanding"].includes(s.typeId)) {
      s.loTag = loTags[loIdx % Math.max(1, loTags.length)] || "";
      loIdx++;
    } else if (s.typeId === "learning_outcomes") {
      s.loTag = loTags[0] || "";
    } else {
      s.loTag = s.loTag || "";
    }
  });

  // Fill bullets from content points (light touch)
  const points = state.inputs.contentPoints.slice(0, 12);
  slides.forEach(s => {
    if (["concept_overview","concept_deepening","framework_model"].includes(s.typeId) && s.bullets.length === 0) {
      s.bullets = points.slice(0, 5);
    }
    if (s.typeId === "application_example" && s.bullets.length === 0) {
      s.bullets = [
        "Apply the concept to a generic scenario",
        "Explain reasoning and decisions",
        "Highlight common pitfalls and best practices"
      ];
    }
    if (s.typeId === "check_understanding" && s.bullets.length === 0) {
      s.bullets = ["Quick diagnostic question", "What would you do next?", "Why?"];
    }
    if (s.typeId === "reflection" && s.bullets.length === 0) {
      s.bullets = ["What changed in your understanding?", "What will you try next time?", "What is still unclear?"];
    }
    if (s.typeId === "genai_practice" && s.bullets.length === 0) {
      s.bullets = state.meta.genaiPolicy === "allowed"
        ? ["Permitted: brainstorming, outlining, feedback", "Required: cite tool use if policy demands", "Prohibited: misrepresentation of authorship"]
        : ["Permitted: limited support (e.g., language clarity)", "Required: disclose use", "Prohibited: generating substantive assessed outputs"];
    }
    if (s.typeId === "assessment_alignment" && s.bullets.length === 0) {
      s.bullets = ["Align tasks to outcomes", "Use transparent criteria and exemplars", "Build checks for authenticity"];
    }
    if (s.typeId === "references" && s.bullets.length === 0) {
      s.bullets = state.inputs.references.slice(0, 8);
    }
  });

  // Time assignment based on pace & duration fit
  slides.forEach(s => {
    s.timeMins = roundToHalf(estimateBaseTimeByType(s.typeId) * paceMultiplier());
  });

  state.blueprint.slides = slides;

  // Nudge time fit: scale times to fit duration while preserving proportions
  autoScaleTimesToFit();

  toast("Blueprint generated.", "ok");
  state.step = 2;
  renderAll();
}

function makeSlide(typeId, title="", loTag="", bullets=[]) {
  const t = title || defaultSlideTitle(typeId);
  return {
    id: uid(),
    typeId,
    title: t,
    loTag: loTag || "",
    bullets: bullets || [],
    speakerNotes: state.meta.includeSpeakerNotes ? defaultSpeakerNotes(typeId) : "",
    timeMins: 2
  };
}

function defaultSpeakerNotes(typeId) {
  const s = strategyName();
  const hints = {
    title_context: `Set expectations: purpose, audience, timing, and approach (${s}).`,
    learning_outcomes: "Read outcomes and clarify what evidence of learning looks like.",
    roadmap: "Walk through the flow; highlight where interaction happens.",
    concept_overview: "Explain the core idea in plain language; anchor with a simple example.",
    concept_deepening: "Add nuance and address common misconceptions.",
    framework_model: "Introduce the framework; explain how parts relate; keep it visual-first.",
    guided_question: "Give 20–30 seconds of think time before sharing.",
    activity_task: "State task, timebox, output format, and success criteria.",
    check_understanding: "Use a quick diagnostic; respond to misconceptions, not just answers.",
    application_example: "Model the reasoning process; make decisions explicit.",
    compare_evaluate: "Invite judgment; ask learners to justify criteria.",
    reflection: "Prompt transfer: what will you do differently next time?",
    assessment_alignment: "Connect outcomes → criteria; explain what ‘good’ looks like.",
    genai_practice: "Clarify acceptable use; emphasize transparency and integrity.",
    references: "Point to core sources; invite further reading.",
    problem_brief: "Present the problem; clarify constraints and expected outputs.",
    roles_accountability: "Assign roles; define accountability and how output is assessed.",
    preclass_tasks: "Explain pre-work and how it will be used in class."
  };
  return hints[typeId] || "Facilitate the slide following the house style and timing.";
}

function roundToHalf(n) { return Math.round(n * 2) / 2; }

function autoScaleTimesToFit() {
  const desired = state.meta.duration;
  const slides = state.blueprint.slides;
  if (!slides.length) return;

  let total = totalTimeMins();
  if (total === 0) return;

  // If within +/-20%, keep it.
  if (Math.abs(total - desired) / desired <= 0.2) return;

  const scale = desired / total;
  slides.forEach(s => {
    // Keep title + refs min time
    const min = (s.typeId === "title_context" || s.typeId === "references") ? 0.5 : 1.0;
    const max = 6.0;
    s.timeMins = clamp(roundToHalf((Number(s.timeMins) || 2) * scale), min, max);
  });
}

/* ---------- Blueprint rendering ---------- */
function renderSlidesList() {
  const host = $("slidesList");
  host.innerHTML = "";

  if (!state.blueprint.slides.length) {
    host.innerHTML = `
      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50 text-sm text-slate-600">
        No slides yet. Go to <span class="font-semibold">Inputs</span> and generate a blueprint.
      </div>
    `;
    return;
  }

  state.blueprint.slides.forEach((s, idx) => {
    const type = slideTypeById(s.typeId);
    const isReq = STRATEGY_RULES[state.meta.strategy]?.required?.includes(s.typeId);
    const chip = isReq ? `<span class="text-[10px] px-2 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700">required</span>` : "";

    const card = document.createElement("div");
    card.className = "p-3 rounded-2xl border border-slate-200 bg-white shadow-sm";
    card.setAttribute("draggable", "true");
    card.dataset.slideId = s.id;

    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-start gap-3 flex-1">
          <div class="drag-hint w-9 h-9 rounded-xl border border-slate-200 bg-slate-50 grid place-items-center text-slate-500">
            <i class="fa-solid fa-grip-vertical"></i>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <div class="text-sm font-semibold">${idx+1}. ${escapeHtml(s.title)}</div>
              <span class="text-[10px] px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600">${type?.label ?? s.typeId}</span>
              ${chip}
              ${s.loTag ? `<span class="text-[10px] px-2 py-1 rounded-full bg-indigo-50 border border-indigo-200 text-indigo-700">${escapeHtml(s.loTag)}</span>` : ``}
            </div>

            <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
              <div>
                <label class="text-xs text-slate-500">Type</label>
                <select class="w-full mt-1 px-2 py-2 rounded-xl border border-slate-200 text-sm slideTypeSelect" data-slide-id="${s.id}">
                  ${SLIDE_TYPES.map(t => `<option value="${t.id}" ${t.id===s.typeId?"selected":""}>${t.label}</option>`).join("")}
                </select>
              </div>
              <div>
                <label class="text-xs text-slate-500">LO mapping</label>
                <select class="w-full mt-1 px-2 py-2 rounded-xl border border-slate-200 text-sm slideLOSelect" data-slide-id="${s.id}">
                  <option value="">(none)</option>
                  ${state.inputs.learningOutcomes.map((_, i) => {
                    const tag = `LO${i+1}`;
                    return `<option value="${tag}" ${tag===s.loTag?"selected":""}>${tag}</option>`;
                  }).join("")}
                </select>
              </div>
              <div>
                <label class="text-xs text-slate-500">Time (mins)</label>
                <input type="number" min="0" step="0.5" value="${s.timeMins}"
                  class="w-full mt-1 px-2 py-2 rounded-xl border border-slate-200 text-sm slideTimeInput"
                  data-slide-id="${s.id}"/>
              </div>
            </div>

            <div class="mt-2">
              <label class="text-xs text-slate-500">Bullets</label>
              <textarea rows="3" class="mt-1 w-full px-2 py-2 rounded-xl border border-slate-200 text-sm soft-scroll slideBulletsInput"
                data-slide-id="${s.id}" placeholder="- bullet">${escapeHtml(s.bullets.join("\n"))}</textarea>
              <div class="mt-1 flex items-center justify-between text-xs text-slate-500">
                <span>${s.bullets.length} bullets</span>
                <span class="${s.bullets.length>6 ? 'text-amber-700' : ''}">${s.bullets.length>6 ? 'Consider splitting (max ~6)' : ''}</span>
              </div>
            </div>

            ${state.meta.includeSpeakerNotes ? `
              <div class="mt-2">
                <label class="text-xs text-slate-500">Speaker notes</label>
                <textarea rows="3" class="mt-1 w-full px-2 py-2 rounded-xl border border-slate-200 text-sm soft-scroll slideNotesInput"
                  data-slide-id="${s.id}" placeholder="Facilitator script">${escapeHtml(s.speakerNotes || "")}</textarea>
              </div>` : ``}
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <button class="btnDel w-9 h-9 rounded-xl border border-slate-200 hover:bg-slate-50 grid place-items-center"
            data-slide-id="${s.id}" title="Delete">
            <i class="fa-solid fa-trash"></i>
          </button>
          <button class="btn
