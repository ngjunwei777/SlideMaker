<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniDeck Pro: Academic Architect</title>
    <!-- PptxGenJS for Export -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- JSZip for Reading PPTX imports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a8a;    /* Academic Blue */
            --secondary: #2563eb;  /* Brighter UI Blue */
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;       /* Darkest Slate */
            --border: #cbd5e1;
            --accent-bg: #eff6ff;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }

        /* HEADER */
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 1.5rem; height: 64px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; }
        .brand { font-family: 'Lora', serif; font-weight: 700; font-size: 1.4rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .api-badge { font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-weight: 600; display: none; }
        .api-badge.active { display: inline-block; }

        /* WIZARD & TABS */
        .wizard-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .wizard-card { background: var(--surface); width: 100%; max-width: 900px; padding: 0; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        
        .wizard-tabs { display: flex; background: #f1f5f9; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 20px; border: none; background: transparent; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; font-size: 1rem; }
        .tab-btn:hover { background: #e2e8f0; color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--secondary); background: white; }
        .tab-btn i { margin-right: 8px; }

        .wizard-content { padding: 40px; }
        .wizard-header h2 { margin: 0 0 10px 0; color: var(--primary); font-family: 'Lora', serif; font-size: 1.8rem; }
        .wizard-header p { color: #475569; margin-top: 0; font-size: 1.05rem; }

        /* FORMS */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.85rem; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em; }
        input, textarea, select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; color: #0f172a; transition: border 0.2s; background: #fff; font-weight: 500; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--secondary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        ::placeholder { color: #94a3b8; font-weight: 400; }

        /* UPLOAD ZONE */
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc; }
        .drop-zone:hover { border-color: var(--secondary); background: #eff6ff; }
        .drop-icon { font-size: 2.5rem; color: #64748b; margin-bottom: 10px; }
        .file-info { margin-top: 10px; font-size: 0.9rem; color: var(--primary); font-weight: 600; }

        /* ACTIVITY GRID */
        .activity-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .activity-card { border: 1px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; background: white; color: #475569; }
        .activity-card:hover { border-color: var(--secondary); transform: translateY(-2px); color: var(--primary); }
        .activity-card.selected { background: var(--accent-bg); border-color: var(--secondary); color: var(--secondary); font-weight: 700; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1); }
        .activity-card i { display: block; font-size: 1.4rem; margin-bottom: 8px; }

        .btn-action { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 25px; transition: opacity 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-action:hover { background: #1e40af; }

        /* EDITOR WORKSPACE */
        .editor-workspace { display: none; flex: 1; height: calc(100vh - 64px); overflow: hidden; }
        .sidebar { width: 280px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .slide-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .thumb { padding: 15px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: white; transition: all 0.2s; position: relative; }
        .thumb:hover { border-color: #94a3b8; }
        .thumb.active { border-color: var(--secondary); box-shadow: 0 0 0 2px var(--secondary); background: #eff6ff; }
        .thumb-num { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; color: #64748b; font-weight: 700; }
        .thumb-title { font-size: 0.9rem; font-weight: 600; color: #0f172a; margin-bottom: 4px; padding-right: 15px; }
        .thumb-type { font-size: 0.65rem; text-transform: uppercase; color: #64748b; font-weight: 600; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; display: inline-block; }

        .main-stage { flex: 1; display: flex; flex-direction: column; padding: 40px; align-items: center; background: #e2e8f0; overflow-y: auto; }

        /* SLIDE PREVIEW */
        .slide-frame { background: white; width: 100%; max-width: 960px; aspect-ratio: 16/9; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border-radius: 4px; padding: 60px 80px; display: flex; flex-direction: column; margin-bottom: 25px; transition: transform 0.2s; }
        
        .slide-frame h2 { margin: 0 0 30px 0; color: var(--primary); font-family: 'Calibri', 'Inter', sans-serif; font-size: 2.8rem; font-weight: 700; text-align: center; border-bottom: none; }
        
        /* IMPROVED CONTRAST FOR PREVIEW TEXT */
        .slide-frame ul { font-size: 2rem; color: #000000; line-height: 1.5; padding-left: 1.2em; margin: 0; text-align: left; font-weight: 500; }
        .slide-frame li { margin-bottom: 16px; }
        
        /* Activity Slide Style */
        .slide-frame.activity { background: #1e3a8a; color: white; justify-content: center; text-align: center; padding: 60px; }
        .slide-frame.activity h2 { color: white; font-size: 3.5rem; margin-bottom: 40px; }
        .slide-frame.activity ul { list-style: none; padding: 0; color: #ffffff; font-size: 2.2rem; text-align: center; font-weight: 600; }

        /* NOTES EDITOR */
        .speaker-notes-container { width: 100%; max-width: 960px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .notes-header { background: #fef3c7; padding: 10px 20px; font-size: 0.8rem; font-weight: 700; color: #92400e; text-transform: uppercase; letter-spacing: 0.05em; display: flex; justify-content: space-between; }
        .notes-editor { width: 100%; padding: 20px; border: none; resize: vertical; min-height: 120px; font-family: 'Lora', serif; font-size: 1.1rem; line-height: 1.8; outline: none; background: transparent; color: #2a1001; font-weight: 500; }

        /* MODALS */
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

        .overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <i class="fas fa-university"></i> UniDeck Pro
        <span id="apiStatus" class="api-badge">KEY LINKED</span>
    </div>
    <button onclick="openApiModal()" style="background:white; border:1px solid #cbd5e1; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; color:#1e293b;">
        <i class="fas fa-key"></i> Settings
    </button>
</header>

<!-- WIZARD AREA -->
<div id="viewWizard" class="wizard-container">
    <div class="wizard-card">
        <!-- TABS -->
        <div class="wizard-tabs">
            <button class="tab-btn active" onclick="switchTab('topic')">
                <i class="fas fa-pen-nib"></i> Generate from Topic
            </button>
            <button class="tab-btn" onclick="switchTab('upload')">
                <i class="fas fa-file-import"></i> Improve Existing Deck/Paper
            </button>
        </div>

        <!-- CONTENT: TOPIC -->
        <div id="tabTopic" class="wizard-content">
            <div class="wizard-header">
                <h2>Course Blueprint</h2>
                <p>Design a university-grade lecture from scratch.</p>
            </div>
            
            <div class="form-group">
                <label>Lecture Topic</label>
                <input type="text" id="inpTopic" placeholder="e.g., The Impact of AI on Macroeconomics">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Audience & Bloom's Level</label>
                    <select id="inpLevel">
                        <option value="Introductory (Remember & Understand)">Introductory (Remember & Understand)</option>
                        <option value="Intermediate (Apply & Analyze)">Intermediate (Apply & Analyze)</option>
                        <option value="Advanced (Evaluate & Create)">Advanced (Evaluate & Create)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <select id="inpDuration">
                        <option value="1h">1 Hour (Standard)</option>
                        <option value="2h">2 Hours (Workshop)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Learning Outcomes</label>
                <textarea id="inpLO" rows="3" placeholder="- Define key terms..."></textarea>
            </div>

            <div class="form-group">
                <label>Pedagogical Mix</label>
                <div class="activity-grid">
                    <div class="activity-card selected" onclick="toggleActivity(this, 'citations')"><i class="fas fa-quote-right"></i> Citations</div>
                    <div class="activity-card" onclick="toggleActivity(this, 'quiz')"><i class="fas fa-list-check"></i> Pop Quiz</div>
                    <div class="activity-card" onclick="toggleActivity(this, 'discussion')"><i class="fas fa-comments"></i> Discussion</div>
                    <div class="activity-card" onclick="toggleActivity(this, 'case')"><i class="fas fa-magnifying-glass"></i> Case Study</div>
                </div>
            </div>

            <button class="btn-action" onclick="generateFromTopic()">
                <i class="fas fa-layer-group"></i> Architect Lesson Plan
            </button>
        </div>

        <!-- CONTENT: UPLOAD -->
        <div id="tabUpload" class="wizard-content" style="display:none;">
            <div class="wizard-header">
                <h2>Enhance Material</h2>
                <p>Upload a PowerPoint (.pptx) or Paste text from a paper to restructure it.</p>
            </div>

            <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt drop-icon"></i>
                <div>Click to upload .PPTX or .TXT</div>
                <div id="fileName" class="file-info"></div>
                <input type="file" id="fileInput" accept=".pptx,.txt,.md" style="display:none" onchange="handleFile(this)">
            </div>

            <div class="form-group" style="margin-top:20px;">
                <label>Or Paste Text Content</label>
                <textarea id="inpPaste" rows="6" placeholder="Paste academic paper content or notes here..."></textarea>
            </div>

            <div class="form-group">
                <label>Enhancement Goals</label>
                <div class="activity-grid">
                    <div class="activity-card selected" onclick="toggleActivity(this, 'structure')"><i class="fas fa-sitemap"></i> Improve Flow</div>
                    <div class="activity-card selected" onclick="toggleActivity(this, 'citations')"><i class="fas fa-quote-right"></i> Add Citations</div>
                    <div class="activity-card" onclick="toggleActivity(this, 'quiz')"><i class="fas fa-list-check"></i> Add Quiz</div>
                    <div class="activity-card" onclick="toggleActivity(this, 'summary')"><i class="fas fa-compress-alt"></i> Summarize</div>
                </div>
            </div>

            <button class="btn-action" onclick="generateFromUpload()">
                <i class="fas fa-magic"></i> Remaster Content
            </button>
        </div>
    </div>
</div>

<!-- EDITOR -->
<div id="viewEditor" class="editor-workspace">
    <div class="sidebar">
        <div class="sidebar-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="returnToWizard()" style="border:none; background:none; cursor:pointer; color:#64748b; font-size:1.1rem; padding:5px;" title="Back to Menu">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span>Outline</span>
            </div>
            <button onclick="clearSlides()" style="border:none; background:none; cursor:pointer; color:#ef4444;" title="Clear"><i class="fas fa-trash"></i></button>
        </div>
        <div class="slide-list" id="slideList"></div>
        <div style="padding:15px; border-top:1px solid var(--border);">
            <button onclick="addSlide()" style="width:100%; padding:10px; border:1px solid var(--border); background:white; border-radius:6px; cursor:pointer; font-weight:600; color:var(--primary);">+ Add Slide</button>
        </div>
    </div>

    <div class="main-stage">
        <div class="slide-frame" id="previewFrame"></div>
        
        <div class="speaker-notes-container">
            <div class="notes-header">
                <span><i class="fas fa-microphone"></i> Lecturer Script</span>
                <span style="opacity:0.7">Hidden from students</span>
            </div>
            <textarea id="inpNotes" class="notes-editor" oninput="updateNotes()"></textarea>
        </div>

        <div style="margin-top:20px;">
            <button onclick="exportDeck()" class="btn-action" style="width:auto; padding:12px 30px; background:var(--primary);">
                <i class="fas fa-download"></i> Download .PPTX
            </button>
        </div>
    </div>
</div>

<!-- OVERLAYS -->
<div id="loadingOverlay" class="overlay">
    <div class="spinner"></div>
    <h3 id="loadTitle" style="color:var(--primary); margin-bottom:5px;">Processing...</h3>
    <p id="loadText" style="color:#64748b; font-family:monospace;">Analyzing content structure...</p>
</div>

<div id="apiModal" class="modal-bg">
    <div class="modal">
        <h3>Gemini API Key</h3>
        <input type="password" id="apiKeyInput" placeholder="Paste key..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
        <div style="display:flex; gap:10px;">
            <button onclick="saveKey()" style="flex:1; padding:10px; background:var(--secondary); color:white; border:none; border-radius:4px; cursor:pointer;">Save</button>
            <button onclick="document.getElementById('apiModal').style.display='none'" style="flex:1; padding:10px; background:#e2e8f0; border:none; border-radius:4px; cursor:pointer;">Close</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let apiKey = localStorage.getItem('unideck_gemini_key') || "";
    if(apiKey) document.getElementById('apiStatus').classList.add('active');
    
    let slides = [];
    let currentIdx = 0;
    let selectedActivities = new Set(['citations', 'structure']);
    let uploadContent = ""; // Stores text from file

    // --- TABS & UI ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.wizard-content').forEach(c => c.style.display = 'none');
        
        if(tab === 'topic') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('tabTopic').style.display = 'block';
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('tabUpload').style.display = 'block';
        }
    }

    function toggleActivity(el, val) {
        el.classList.toggle('selected');
        selectedActivities.has(val) ? selectedActivities.delete(val) : selectedActivities.add(val);
    }

    function openApiModal() {
        document.getElementById('apiModal').style.display = 'flex';
        document.getElementById('apiKeyInput').value = apiKey;
    }

    function saveKey() {
        const k = document.getElementById('apiKeyInput').value.trim();
        if(k) {
            apiKey = k;
            localStorage.setItem('unideck_gemini_key', k);
            document.getElementById('apiStatus').classList.add('active');
        }
        document.getElementById('apiModal').style.display = 'none';
    }

    // FIXED: Non-blocking return logic
    function returnToWizard() {
        document.getElementById('viewEditor').style.display = 'none';
        document.getElementById('viewWizard').style.display = 'flex';
    }

    function clearSlides() {
        if(confirm('Clear all slides?')) { 
            slides=[]; 
            renderList(); 
            // Reset Preview
            document.getElementById('previewFrame').innerHTML = "<h2 style='text-align:center; color:#ccc; margin-top:50px;'>No slides generated</h2>";
            document.getElementById('inpNotes').value = "";
        }
    }

    // --- FILE HANDLING ---
    async function handleFile(input) {
        const file = input.files[0];
        if(!file) return;
        document.getElementById('fileName').innerText = file.name;
        
        if(file.name.endsWith('.pptx')) {
            try {
                const zip = await JSZip.loadAsync(file);
                let text = "";
                let i = 1;
                while(true) {
                    const f = zip.file(`ppt/slides/slide${i}.xml`);
                    if(!f) break;
                    const xml = await f.async("string");
                    // Simple Regex XML Text Extraction
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xml, "text/xml");
                    const tspans = doc.getElementsByTagName("a:t");
                    let slideText = "";
                    for(let j=0; j<tspans.length; j++) slideText += tspans[j].textContent + " ";
                    text += `\n[Slide ${i}]: ${slideText}`;
                    i++;
                }
                uploadContent = text;
            } catch(e) { alert("Error reading PPTX: " + e); }
        } else {
            const reader = new FileReader();
            reader.onload = e => uploadContent = e.target.result;
            reader.readAsText(file);
        }
    }

    // --- GENERATION: TOPIC ---
    async function generateFromTopic() {
        const topic = document.getElementById('inpTopic').value;
        const level = document.getElementById('inpLevel').value;
        if(!topic) return alert("Enter a topic");
        
        const prompt = `
            Act as a University Professor. Create a rigorous lecture on "${topic}".
            Audience & Bloom's Taxonomy Level: ${level}.
            Duration: ${document.getElementById('inpDuration').value}.
            Outcomes: ${document.getElementById('inpLO').value}.
            Include: ${Array.from(selectedActivities).join(", ")}.

            DESIGN RULES:
            1. PEDAGOGY: Strictly align verbs, questions, and content depth with the "${level}" level of Bloom's Taxonomy.
            2. PHRASING: Use "Learner View". Engaging concepts, active verbs.
            3. SLIDES: "Less is More". Max 6 bullets/slide. Max 8 words/bullet. NO PARAGRAPHS.
            4. NOTES: Detailed narrative script for the lecturer (definitions, examples).
            5. CITATIONS: APA 7th Gen (Author, Year).
            6. FORMAT: Final slide must be Bibliography.

            Output strictly JSON array:
            [{ "type": "title|content|activity|reference", "title": "...", "body": "...", "notes": "..." }]
        `;
        
        runAI(prompt);
    }

    // --- GENERATION: UPLOAD ---
    async function generateFromUpload() {
        const text = document.getElementById('inpPaste').value || uploadContent;
        if(!text) return alert("Please upload a file or paste text.");
        if(text.length < 50) return alert("Not enough content to process.");

        const prompt = `
            Act as an Academic Editor. I have raw content/notes. Restructure this into a professional University Lecture Slide Deck.
            
            SOURCE MATERIAL:
            "${text.substring(0, 25000)}" 

            Enhancement Goals: ${Array.from(selectedActivities).join(", ")}.

            DESIGN RULES:
            1. RESTRUCTURE: Group related points. Create logical flow.
            2. SLIDES: Max 6 bullets/slide. Short punchy lines.
            3. NOTES: Move detailed text from source into speaker notes.
            4. CITATIONS: Add dummy APA citations if source lacks them but facts need support.

            Output strictly JSON array:
            [{ "type": "title|content|activity|reference", "title": "...", "body": "...", "notes": "..." }]
        `;

        runAI(prompt);
    }

    // --- CORE AI ENGINE ---
    async function runAI(prompt) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        if(!apiKey) {
            setTimeout(() => {
                // Demo Data
                slides = [
                    { type: "title", title: "Demo: Behavioral Economics", body: "Prof. Demo User", notes: "Intro" },
                    { type: "content", title: "Core Concept", body: "- Rationality is bounded [Simon, 1955]\n- Biases affect decisions", notes: "Explain Simon's theory." },
                    { type: "reference", title: "References", body: "Simon, H. A. (1955). QJE.", notes: "" }
                ];
                launchEditor();
            }, 2000);
            return;
        }

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const resp = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const json = await resp.json();
            if(json.error) throw new Error(json.error.message);
            
            let txt = json.candidates[0].content.parts[0].text;
            const start = txt.indexOf('[');
            const end = txt.lastIndexOf(']');
            if(start > -1 && end > -1) txt = txt.substring(start, end+1);
            
            slides = JSON.parse(txt).map(s => ({
                ...s,
                body: Array.isArray(s.body) ? s.body.join('\n') : (s.body || "")
            }));
            
            launchEditor();
        } catch(e) {
            alert("AI Error: " + e.message);
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    // --- EDITOR ---
    function launchEditor() {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('viewWizard').style.display = 'none';
        document.getElementById('viewEditor').style.display = 'flex';
        renderList();
        loadSlide(0);
    }

    function renderList() {
        const list = document.getElementById('slideList');
        list.innerHTML = "";
        slides.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = `thumb ${i === currentIdx ? 'active' : ''}`;
            div.onclick = () => loadSlide(i);
            div.innerHTML = `
                <div class="thumb-num">${i+1}</div>
                <div class="thumb-title">${s.title}</div>
                <div class="thumb-type">${s.type}</div>
            `;
            list.appendChild(div);
        });
    }

    function loadSlide(i) {
        if (!slides[i]) return;
        currentIdx = i;
        const s = slides[i];
        document.getElementById('inpNotes').value = s.notes || "";
        
        document.querySelectorAll('.thumb').forEach((el, idx) => el.classList.toggle('active', idx === i));

        const frame = document.getElementById('previewFrame');
        frame.className = `slide-frame ${s.type}`;
        
        let html = `<h2>${s.title}</h2>`;
        // Body Safety Check
        let safeBody = s.body || "";
        if (Array.isArray(safeBody)) safeBody = safeBody.join('\n');
        
        if(safeBody) {
            const lines = safeBody.split('\n');
            if(s.type === 'reference') {
                html += `<ul style="list-style:none; font-size:1.2rem;">${lines.map(l=>`<li>${l}</li>`).join('')}</ul>`;
            } else {
                html += "<ul>" + lines.map(l => {
                    const txt = l.replace(/(\[.*?\])/g, '<span style="color:#3b82f6; font-size:0.7em; vertical-align:super;">$1</span>').replace(/^-/, '').trim();
                    return txt ? `<li>${txt}</li>` : '';
                }).join('') + "</ul>";
            }
        }
        frame.innerHTML = html;
    }

    function updateNotes() { if(slides[currentIdx]) slides[currentIdx].notes = document.getElementById('inpNotes').value; }
    
    function addSlide() { 
        slides.splice(currentIdx+1, 0, { type: "content", title: "New Slide", body: "- Point 1", notes: "" });
        renderList(); loadSlide(currentIdx+1);
    }

    // --- EXPORT (OPTIMIZED FONTS) ---
    function exportDeck() {
        if(!slides || slides.length === 0) return alert("No slides to export!");

        let pres = new PptxGenJS();
        pres.layout = 'LAYOUT_16x9';

        pres.defineSlideMaster({
            title: 'MASTER',
            background: { color: 'FFFFFF' },
            objects: [
                { rect: { x: 0, y: 0, w: '100%', h: 0.8, fill: { color: 'f1f5f9' } } },
                { line: { x: 0, y: 0.8, w: '100%', h: 0, line: { color: '1e3a8a', width: 2 } } },
                { text: { text: "UniDeck Pro", options: { x: 0.5, y: 7.2, fontSize: 10, color: '94a3b8' } } },
                { text: { text: "{slide_number}", options: { x: 12.5, y: 7.2, fontSize: 10, color: '94a3b8' } } }
            ]
        });

        slides.forEach(s => {
            let slide = pres.addSlide({ masterName: 'MASTER' });
            
            // 1. Header: Calibri, 44, Center
            slide.addText(s.title, { 
                x: 0, y: 0.1, w: '100%', h: 0.8, 
                fontSize: 44, bold: true, color: '1e3a8a', 
                fontFace: 'Calibri', align: 'center' 
            });

            // Ensure contentStr is string
            let contentStr = s.body || "";
            if (Array.isArray(contentStr)) contentStr = contentStr.join('\n');
            if (typeof contentStr !== 'string') contentStr = String(contentStr);

            if(s.type === 'activity') {
                slide.background = { color: '1e3a8a' };
                slide.addText("ACTIVITY", { x:0, y:0.5, w:'100%', align:'center', color:'60a5fa', bold:true, letterSpacing:3 });
                slide.addText(s.title, { x:1, y:1.5, w:'80%', align:'center', fontSize:44, color:'ffffff', bold:true, fontFace:'Calibri' });
                slide.addText(contentStr, { x:1.5, y:3.0, w:'70%', align:'center', fontSize:32, color:'e2e8f0' });
            } else {
                // 2. Body: Size 28, Left Align, 1.0 spacing
                let bullets = contentStr.split('\n').filter(l=>l).map(l => ({ 
                    text: l.replace(/^-/, '').trim(), 
                    options: { 
                        fontSize: 28, // Optimized for 6 bullets
                        align: 'left',
                        breakLine: true, 
                        bullet: (s.type !== 'reference'),
                        lineSpacing: 34,
                        color: '000000' // ENSURE BLACK TEXT
                    } 
                }));

                slide.addText(bullets, { 
                    x: 0.5, y: 1.2, w: '90%', h: 5.5, 
                    valign: 'top', color: '000000' 
                });
            }
            if(s.notes) slide.addNotes(s.notes);
        });

        pres.writeFile({ fileName: 'Enhanced_Lecture.pptx' });
    }
</script>
</body>
</html>
